YUI.add("moodle-atto_edusharing-button",function(e,t){function i(e){this.name="",this.object_url="",this.course=e,this.id="",this.object_version="0"}var n="atto_edusharing",r='<div id="edusharing_hint"> <img src="" id="edusharing_hint_logo">{{get_string "hint" component}} <div class="edusharing_center edusharing_hint_buttons"><a id="edusharing_hint_close" class="btn" href="#">{{get_string "cancel" component}}</a> <button id="edusharing_open_repo" class="btn btn-primary">{{get_string "openRepo" component}}</button></div> <input type="checkbox" id="edusharing_hint_check" name="edusharing_hint_check" value="dontshow" /> {{get_string "skipHint" component}} </div> <form id="edusharing_form" class="atto_form" style="display: none"> <input id="edusharing_object_url" name="edusharing_object_url" type="hidden" value="" /> <input id="edusharing_resid" name="edusharing_resid" type="hidden" value="" /> <input id="edusharing_mimetype" name="edusharing_mimetype" type="hidden" value="" /><input id="edusharing_mediatype" name="edusharing_mediatype" type="hidden" value="" /> <input id="edusharing_preview_url" name="edusharing_preview_url" type="hidden" value="" /> <input id="edusharing_version" name="edusharing_version" type="hidden" value="" /> <input id="edusharing_ratio" name="edusharing_ratio" type="hidden" value="" /> <h2>{{get_string "title" component}}</h2> <input id="edusharing_title" name="edusharing_title" value="" maxlength="25"/><i id="edusharing_title_pencil" class="icon fa fa-pencil fa-fw " aria-hidden="true"></i> <span style="position:absolute; color: rgba(0, 0, 0, 0); display:inline-block; font-size:2em;" id="edusharing_title_helper" name="edusharing_title_helper" value=""></span> <img src="" id="edusharing_preview"> <div id="edusharing_hint_directory" style="display:none"> {{get_string "directoryHint" component}}</div><br/><input type="checkbox" id="edusharing_version_latest" name="edusharing_version_latest" /><label for="edusharing_version_latest" class="edusharing_label_inline" id="edusharing_version_latest_label"> {{get_string "alwaysShowLatestVersion" component}}</label> <div id="edusharing_wrapper_caption" class="edusharing_form_wrapper"> <h2>{{get_string "subtitle" component}}</h2> <input id="edusharing_caption" name="edusharing_caption" value="" /> </div><div id="edusharing_wrapper_alignment" class="edusharing_form_wrapper"> <h2>{{get_string "alignment" component}}</h2> <div class="edusharing_wrapper_alignment_radiowrapper"> <input type="radio" id="edusharing_alignment_left" name="edusharing_alignment" value="left"> <label for="edusharing_alignment_left" class="edusharing_label_inline">{{get_string "alignmentLeft" component}}</label> </div><div class="edusharing_wrapper_alignment_radiowrapper"> <input type="radio" id="edusharing_alignment_right" name="edusharing_alignment" value="right"><label for="edusharing_alignment_right" class="edusharing_label_inline">{{get_string "alignmentRight" component}}</label> </div><div class="edusharing_wrapper_alignment_radiowrapper"><input type="radio" id="edusharing_alignment_none" name="edusharing_alignment" value="none" checked="checked"><label for="edusharing_alignment_none" class="edusharing_label_inline">{{get_string "alignmentNone" component}}</label> </div></div> <div id="edusharing_wrapper_dimensions" class="edusharing_form_wrapper"> <h2>{{get_string "dimensions" component}}</h2><div style="float:left;margin-right: 20px;"><label for="edusharing_width">{{get_string "dimensionsWidth" component}}</label><input type="number" id="edusharing_width" name="edusharing_width" value="" maxlength="4" length="4" /> px</div> <div><label for="edusharing_height">{{get_string "dimensionsheight" component}}</label> <input type="number" id="edusharing_height" name="edusharing_height" value="" maxlength="4" length="4"/> px</div> </div> <div id="edusharing_wrapper_buttons" class="edusharing_form_wrapper"> <a id="edusharing_dialog_cancel" class="btn" href="#">{{get_string "cancel" component}}</a><button id="edusharing_submit" class="btn btn-primary">{{get_string "insert" component}}</button> </div> </form>';e.namespace("M.atto_edusharing").Button=e.Base.create("button",e.M.editor_atto.EditorPlugin,[],{initializer:function(){if(this.get("disabled"))return;this.addButton({icon:"icon",iconComponent:"atto_edusharing",buttonName:"icon",callback:this._displayDialogue,callbackArgs:"icon",tags:".edusharing",tagMatchRequiresAll:!1});var e=this.get("host").textarea.ancestor("form");e&&e.on("submit",this.eduSubmit,this),this.getExistingObjects();var t=this;window.addEventListener("message",function(e){if(e.data.event=="APPLY_NODE"){var n=e.data.data;window.win.close(),t.updateDialog(n)}},!1)},getExistingObjects:function(){var e=this.get("host").textarea.get("value"),t=document.createElement("div");t.innerHTML=e;var n=[t];while(0<n.length){var r=n.shift();if(1==r.nodeType&&r.getAttribute("es:resource_id")){var s=new i(this.get("courseid"));s.importNode(r)?this.get("existingObjects")[s.id]=s:(alert("error_importing_node"),r.parentNode.removeChild(r))}if(r.hasChildNodes()){child=0;while(child<r.childNodes.length)n.push(r.childNodes.item(child)),child++}}},updateDialog:function(t,r){e.one("#edusharing_form").set("style","display:block"),e.one("#edusharing_hint").set("style","display:none");if(t.isDirectory)e.one("#edusharing_wrapper_dimensions").set("style","display:none"),e.one("#edusharing_version_latest").set("style","visibility:hidden"),e.one("#edusharing_version_latest_label").set("style","visibility:hidden"),e.one("#edusharing_wrapper_alignment").set("style","visibility:hidden"),e.one("#edusharing_hint_directory").set("style","display:block");else if(this.getType(t.mediatype)=="ref")e.one("#edusharing_wrapper_dimensions").set("style","visibility:hidden");else{var i=t.properties["ccm:width"]||600,s=t.properties["ccm:height"]||400;e.one("#edusharing_width").set("value",i),e.one("#edusharing_height").set("value",s),e.one("#edusharing_ratio").set("value",i/s)}e.one("#edusharing_title"
).set("value",t.title||t.name),e.one("#edusharing_caption").set("value",t.caption||""),e.one("#edusharing_object_url").set("value",t.objectUrl),e.one("#edusharing_mimetype").set("value",t.mimetype),e.one("#edusharing_mediatype").set("value",t.mediatype),e.one("#edusharing_preview_url").set("value",t.preview.url),e.one("#edusharing_preview").set("src",t.preview.url),e.one("#edusharing_version").set("value",t.properties["cclom:version"]),r&&(e.one("#edusharing_resid").set("value",t.resid),e.one("#edusharing_version_latest").set("style","display:none"),e.one("#edusharing_version_latest_label").set("style","display:none"),e.one("#edusharing_submit").setContent(M.util.get_string("update",n)),t.alignment?(e.one("#edusharing_alignment_none").set("checked",!1),e.one("#edusharing_alignment_"+t.alignment).set("checked",!0)):(e.one("#edusharing_alignment_none").set("checked",!0),e.one("#edusharing_alignment_right").set("checked",!1),e.one("#edusharing_alignment_left").set("checked",!1)))},eduSubmit:function(){var e=this.get("host").textarea.get("value"),t=document.createElement("div");t.innerHTML=e;var n=[t];while(0<n.length){var r=n.shift();if(r.nodeType==1&&r.getAttribute("es:object_url")){var s=r.getAttribute("es:resource_id");if(this.get("existingObjects")[s])delete this.get("existingObjects")[s];else{var o=new i(this.get("courseid"));o.importNode(r)||alert("error_importing_node"),o.link(r)||(alert("error_setting_usage"),r.parentNode.removeChild(r)),r.setAttribute("es:resource_id",o.id),this.getType(r.getAttribute("es:mediatype"))=="content"&&r.setAttribute("src",this.getPreviewUrl(o.id))}}if(r.hasChildNodes()){child=0;while(child<r.childNodes.length)n.push(r.childNodes.item(child)),child++}}for(var s in this.get("existingObjects")){var u=this.get("existingObjects")[s];u.unlink(r)||alert("error_deleting_usage")}this.get("host").textarea.set("value",t.innerHTML)},getPreviewUrl:function(e){var t=M.cfg.wwwroot+"/lib/editor/atto/plugins/edusharing/preview.php";return t+="?resourceId="+e,t},getSelectedElement:function(){var e=this.get("host").getSelectedNodes()._nodes[0];return e&&e.nodeType&&e.nodeType==3&&(e=e.parentElement),e&&e.attributes&&e.attributes["es:object_url"]?e:""},handleUpdate:function(){var e,t=[];return e=this.getSelectedElement(),e?(e.attributes["es:mediatype"].value=="folder"&&(t.isDirectory=!0),e.attributes["es:resource_id"]&&(t.resid=e.attributes["es:resource_id"].value),t.title=e.attributes.title.value,t.caption=e.attributes["es:caption"].value,t.properties=[],e.attributes.width&&(t.properties["ccm:width"]=e.attributes.width.value),e.attributes.height&&(t.properties["ccm:height"]=e.attributes.height.value),t.objectUrl=e.attributes["es:object_url"].value,t.mimetype=e.attributes["es:mimetype"].value,t.mediatype=e.attributes["es:mediatype"].value,t.preview=[],e.currentSrc?t.preview.url=e.currentSrc:t.preview.url=this.getPreviewUrl(e.attributes["es:resource_id"].value),t.properties["cclom:version"]=e.attributes["es:window_version"].value,t.alignment=e.style.float,this.updateDialog(t,!0),!0):!1},_displayDialogue:function(t,r){t.preventDefault();var i=800,s=600,o=this.getDialogue({headerContent:M.util.get_string("dialogtitle",n),width:i+"px",height:s+"px",focusAfterHide:r});o.width!==i+"px"&&o.set("width",i+"px");var u=this._getFormContent(r),a=e.Node.create("<div></div>");a.append(u),o.set("bodyContent",a);var f=this.handleUpdate();f||(e.one("#edusharing_hint_logo").setAttribute("src",this.get("repourl")+"/assets/images/logo.svg"),e.Cookie.get("edusharing_hint_hide")?(this.open_repo(),e.one("#edusharing_hint_check").setAttribute("checked","checked")):e.one("#edusharing_hint_check").removeAttribute("checked")),o.show(),this.markUpdated()},_getFormContent:function(t){var i=e.Handlebars.compile(r),s=e.Node.create(i({component:n,clickedicon:t}));return this._form=s,this._form.one("#edusharing_submit").on("click",this._doInsert,this),this._form.one("#edusharing_hint_check").setAttribute("checked","checked"),this._form.one("#edusharing_hint_check").on("change",this.edusharing_hint_check_change,this),this._form.one("#edusharing_open_repo").on("click",this.open_repo,this),this._form.one("#edusharing_hint_close").on("click",this.closeDialog,this),this._form.one("#edusharing_dialog_cancel").on("click",this.closeDialog,this),this._form.one("#edusharing_width").on("change",this.recalculateDimensions,this),this._form.one("#edusharing_width").on("keyup",this.recalculateDimensions,this),this._form.one("#edusharing_height").on("change",this.recalculateDimensions,this),this._form.one("#edusharing_height").on("keyup",this.recalculateDimensions,this),this._form.one("#edusharing_title").on("keyup",this.recalculateTitleWidth,this),s},recalculateTitleWidth:function(){e.one("#edusharing_title_helper").setContent(e.one("#edusharing_title").get("value")),e.one("#edusharing_title").setStyle("width",e.one("#edusharing_title_helper").get("offsetWidth")+10+"px")},closeDialog:function(e){e.preventDefault(),this.getDialogue({focusAfterHide:null}).hide()},open_repo:function(){var e=this.get("repourl")+"/components/search?reurl=WINDOW&applyDirectories=true&ticket="+this.get("ticket");window.win=window.open(e)},recalculateDimensions:function(t){t._currentTarget.id=="edusharing_height"?e.one("#edusharing_width").set("value",Math.round(e.one("#edusharing_height").get("value")*e.one("#edusharing_ratio").get("value"))):e.one("#edusharing_height").set("value",Math.round(e.one("#edusharing_width").get("value")/e.one("#edusharing_ratio").get("value")))},edusharing_hint_check_change:function(e){YUI().use("cookie",function(t){e.target._stateProxy.checked?t.Cookie.set("edusharing_hint_hide",!0,{expires:new Date("January 12, 2025")}):t.Cookie.remove("edusharing_hint_hide")})},_doInsert:function(e){e.preventDefault(),this.getDialogue({focusAfterHide:null}).hide(),this.editor.focus();var t=this.getNode();if(t.resid){var n=this.getSelectedElement();n.setAttribute("title",t.title),n.setAttribute("alt",t.title),n.setAttribute("es:caption"
,t.caption);var r="";t.alignment!="none"&&(r="float:"+t.alignment),n.setAttribute("style",r),this.getType(t.mediatype)=="ref"?n.innerHTML=t.title:(n.setAttribute("width",t.width),n.setAttribute("height",t.height))}else{var r="";t.alignment!="none"&&(r="float:"+t.alignment+";");var i="0";0==t.showlatest&&(i=t.version);var s='class="edusharing" style="'+r+'" '+'alt="'+t.title+'" '+'title="'+t.title+'" '+'es:caption="'+t.caption+'" '+'xmlns:es="http://www.edu-sharing.net/editor/" '+'es:object_url="'+t.objecturl+'" '+'es:mediatype="'+t.mediatype+'" '+'es:mimetype="'+t.mimetype+'" '+'es:window_float="'+t.alignment+'" '+'es:window_version="'+i+'" '+'es:repotype="ALFRESCO" ';t.type=="ref"?s="<a "+s+">"+t.title+"</a>":(s+='src="'+t.previewurl+'" '+'width="'+t.width+'" '+'height="'+t.height+'" ',s="<img "+s+" />"),this.get("host").insertContentAtFocusPoint(s)}this.markUpdated()},getType:function(e){var t="ref";switch(!0){case e.indexOf("image")>-1:case e.indexOf("video")>-1:case e.indexOf("h5p")>-1:case e.indexOf("learningapps")>-1:case e.indexOf("youtube")>-1:case e.indexOf("vimeo")>-1:case e.indexOf("folder")>-1:t="content"}return t},getNode:function(){var t={};return t.resid=e.one("#edusharing_resid").get("value"),t.title=e.one("#edusharing_title").get("value"),t.caption=e.one("#edusharing_caption").get("value"),t.width=e.one("#edusharing_width").get("value"),t.height=e.one("#edusharing_height").get("value"),t.previewurl=e.one("#edusharing_preview_url").get("value"),t.objecturl=e.one("#edusharing_object_url").get("value"),t.mimetype=e.one("#edusharing_mimetype").get("value"),t.mediatype=e.one("#edusharing_mediatype").get("value"),t.showlatest=e.one("#edusharing_version_latest").get("checked"),t.version=e.one("#edusharing_version").get("value"),t.alignment=e.one("input[name=edusharing_alignment]:checked").get("value"),t.type=this.getType(t.mediatype),t.mediatype=="folder"&&(t.showlatest=!0,t.width=500),t}},{ATTRS:{disabled:{value:!1},repourl:{value:""},courseid:{value:""},ticket:{value:""},existingObjects:{value:[]}}}),i.prototype.importNode=function(t){var n=t.getAttribute("title");if(!n)return!1;this.name=n;var r=t.getAttribute("es:object_url");if(!r)return!1;this.object_url=r;var i=t.getAttribute("es:resource_id");i&&(this.id=i);var s=t.getAttribute("es:window_version");return s&&(this.object_version=s),!0},i.prototype.link=function(t){var n=M.cfg.wwwroot+"/lib/editor/atto/plugins/edusharing/insert.php?sesskey="+M.cfg.sesskey,r=this,i=YUI().use("io","json"),s={method:"POST",sync:!0,data:i.JSON.stringify(r),arguments:{},on:{success:function(e,t,n){try{var s=i.JSON.parse(t.responseText)}catch(o){return alert("invalid data"),!1}return s.id?(r.id=s.id,!0):(alert("no resource id"),!1)},failure:function(e,t,n){return alert("error setting usage"),!1}}};return i.io(n,s)},i.prototype.unlink=function(t){var n=M.cfg.wwwroot+"/lib/editor/atto/plugins/edusharing/delete.php?sesskey="+M.cfg.sesskey,r=this,i=YUI().use("io","json","json-stringify"),s={method:"POST",sync:!0,headers:{"Content-Type":"application/json"},data:i.JSON.stringify(r),arguments:{object:r,node:t},on:{success:function(e,t,n){return!0},failure:function(e,t,n){return alert("error deleting object "+r.id+"."),!1}}};return i.io(n,s)}},"@VERSION@",{requires:["moodle-editor_atto-plugin"]});
